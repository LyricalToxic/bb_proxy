"""add rotate strategy and protocol

Revision ID: 29d57de76d74
Revises: 680a9c8176f8
Create Date: 2022-03-30 18:24:57.844348

"""
import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision = '29d57de76d74'
down_revision = '680a9c8176f8'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('proxy_comrades', schema=None, recreate='always') as batch_op:
        batch_op.add_column(sa.Column('rotate_strategy', sa.INTEGER(), server_default=sa.text('0'), nullable=False),
                            insert_after="used_bandwidth_b")
    op.execute(
            "CREATE TRIGGER IF NOT EXISTS UpdateOnCurrentTimestamp2 "
            "AFTER UPDATE "
            "ON proxy_comrades "
            "FOR EACH ROW "
            "BEGIN "
            "update proxy_comrades set updated_at=CURRENT_TIMESTAMP WHERE id = NEW.id; "
            "END;"
        )

    with op.batch_alter_table('proxy_credentials', schema=None, recreate='always') as batch_op:
        batch_op.add_column(sa.Column('protocol', sa.VARCHAR(length=255), nullable=False),
                            insert_after="type")
    op.execute(
            "CREATE TRIGGER IF NOT EXISTS UpdateOnCurrentTimestamp1 "
            "AFTER UPDATE "
            "ON proxy_credentials "
            "FOR EACH ROW "
            "BEGIN "
            "update proxy_credentials set updated_at=CURRENT_TIMESTAMP WHERE id = NEW.id; "
            "END;"
        )

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('proxy_credentials', schema=None) as batch_op:
        batch_op.drop_column('protocol')

    with op.batch_alter_table('proxy_comrades', schema=None) as batch_op:
        batch_op.drop_column('rotate_strategy')
    # ### end Alembic commands ###
